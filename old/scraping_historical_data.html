<!DOCTYPE html>
<html >
<head>
  <meta charset="UTF-8">
  <title>Scraping Data</title>
  
  
  <link rel='stylesheet prefetch' href='https://fonts.googleapis.com/css?family=Inconsolata|Space+Mono:700'>
<link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css'>
<link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css'>

      <link rel="stylesheet" href="css/style.css">

      <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-89638118-1', 'auto');
  ga('send', 'pageview');

</script>
</head>

<body>
  <main>
  <style>
  a {
  	color: brown
  }
  .shorter {
    width: 450px;
  }
  </style>
  <div class="preview__link" href="#" itemprop="url">
              <span class="preview__date" itemprop="datePublished" datetime="2016-09-07T00:00:00-07:00">Jan 02, 2017</span>
              <center><h2 class="preview__header" itemprop="name">Scraping Historical Data</h2></center>
              <center><u><h4>Why Scrape?</h4></u></center>
              <p>Subscriptions to historical financial databases are expensive, some costing over $20,000 per year. Most of these data sources have tick data as well as end of day data. Using python, we can scrape data from yahoo finance and create our own collection of stock data in csv format that we can use for analysis.</p>
              <center><u><h4>Libraries We Need</h4></u></center>
              <p>To scrape our data, we need to make sure that we have pandas installed. Specifically, we will need the package pandas_datareader.data. If you followed the instructions in the post where we setup the quant environment, you should already have this installed. If you do not have this package simply go to your terminal and type in pip install pandas and hit enter. Then, type in pip install pandas-datareader and hit enter. The packages should download onto your machine. We will also make use of the following built-in python libraries: os, datetime, and time.</p>
              <center><u><h4>What Our Program Will Do</h4></u></center>
              <p>Our program will take in a start and end date as well as a list of tickers. The program will download the open, high, low, close, volume, and adjusted close prices of each stock for the specified time period. We will also pass in a parameter that will allow us to download all available data for each stock in our list of tickers. Yahoo Finance sometimes blocks IP addresses that request too much data (for instance if we passed in a list of 500 tickers) so we will create some conditions that pause our program automatically so it looks like we are not requesting too much data. Let's get started!</p>

              <center><u><h4>Implementation</h4></u></center>
              <p>We first need to import four libraries: pandas_datareader.data, os, datetime, and time. We use the pandas_datareader to use pandas functionality to pull data from yahoo finance. We will use the os module to create a directory for our stock data if it does not already exist. We use the datetime module to obtain the current date if the user wants to download all data, and we use the time module to pause our python program so that we do not send too many data pulling requests to yahoo finance. Let us first create a python file called data_scraper.py and import the four libraries as follows:</p>
              <div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">pandas_datareader.data</span> <span style="color: #0000aa">as</span> <span style="color: #00aaaa; text-decoration: underline">web</span>
<span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">os</span>
<span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">datetime</span>
<span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">time</span>
</pre></div>
            <p>We now will create our function called download_data. It will take in a list of tickers, a start date, an end date, and a parameter called all_data which is optional to download all historical data for the specified ticker. Inside our function we need to create a count variable and set it to 1. Each time we download data for a stock we will update the count variable and when our count variable equals 50 it means we have made 50 requests. We will then let our python program sleep for 10 seconds before we pull more data. This is just a safety net so that yahoo finance does not restrict our access to data. We have an all_data variable that is set to flase originally. If the user specifies that all_data=True then we will use the datetime module to obtain the current date and then we will reformat the datetime variable into a string that has the format month-day-year, which will be stored in the end variable. We will let our start be January 1, 1970 as yahoo finance supports dates that date back this far. The nice thing about our scraper is that say a Stock started trading on 02-05-1984, we can let our start variable be 01-01-1970 and our data will be pulled from the date the stock started trading. Our program implementation so far is as follows:</p>
            <div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">pandas_datareader.data</span> <span style="color: #0000aa">as</span> <span style="color: #00aaaa; text-decoration: underline">web</span>
<span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">os</span>
<span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">datetime</span>
<span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">time</span>

<span style="color: #0000aa">def</span> <span style="color: #00aa00">download_data</span>(tickers,start,end,all_data=<span style="color: #00aaaa">False</span>):
    count = <span style="color: #009999">1</span>
    <span style="color: #0000aa">if</span> all_data==<span style="color: #00aaaa">True</span>:
        end = datetime.datetime.now()
        end = <span style="color: #aa5500">&#39;%s-%s-%s&#39;</span> % (end.month,end.day,end.year)
        start = <span style="color: #aa5500">&#39;01-01-1970&#39;</span>
</pre></div>
        <p>We now need to create a directory to hold our stock data, we will call this directory stock_data. We can have python create this directory for us if it does not already exist. To do so we will use the os module to check if our directory exists and if it does not exist we will use the command os.makedirs(directory) to create the directory that will hold all of our csv stock data. With this implemented, our program is so far as follows:</p>
        <div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">pandas_datareader.data</span> <span style="color: #0000aa">as</span> <span style="color: #00aaaa; text-decoration: underline">web</span>
<span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">os</span>
<span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">datetime</span>
<span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">time</span>

<span style="color: #0000aa">def</span> <span style="color: #00aa00">download_data</span>(tickers,start,end,all_data=<span style="color: #00aaaa">False</span>):
    count = <span style="color: #009999">1</span>
    <span style="color: #0000aa">if</span> all_data==<span style="color: #00aaaa">True</span>:
        end = datetime.datetime.now()
        end = <span style="color: #aa5500">&#39;%s-%s-%s&#39;</span> % (end.month,end.day,end.year)
        start = <span style="color: #aa5500">&#39;01-01-1970&#39;</span>

    directory = <span style="color: #aa5500">&#39;stock_data&#39;</span>
    <span style="color: #0000aa">if</span> <span style="color: #0000aa">not</span> os.path.exists(directory):
        os.makedirs(directory)
</pre></div>
        <p>We now create an empty dictionary to hold our stock data. We then index through our list of tickers and create a filename to hold each stock. Say our list of tickers was ['AAPL','BAC','GILD']. We first start with 'AAPL' and create a filename called 'stock_data/AAPL.csv'. We then scrape the data with the pandas data reader, which takes in the ticker (in our case AAPL), the parameter 'yahoo', and our start and end date. In the case of our example, will store this date in d['AAPL'] and then write d['AAPL'] to a csv file. We will repeat this process for each stock in our list of tickers. Our code so far looks as follows:</p>
        <div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">pandas_datareader.data</span> <span style="color: #0000aa">as</span> <span style="color: #00aaaa; text-decoration: underline">web</span>
<span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">os</span>
<span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">datetime</span>
<span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">time</span>

<span style="color: #0000aa">def</span> <span style="color: #00aa00">download_data</span>(tickers,start,end,all_data=<span style="color: #00aaaa">False</span>):
    count = <span style="color: #009999">1</span>
    <span style="color: #0000aa">if</span> all_data==<span style="color: #00aaaa">True</span>:
        end = datetime.datetime.now()
        end = <span style="color: #aa5500">&#39;%s-%s-%s&#39;</span> % (end.month,end.day,end.year)
        start = <span style="color: #aa5500">&#39;01-01-1970&#39;</span>

    directory = <span style="color: #aa5500">&#39;stock_data&#39;</span>
    <span style="color: #0000aa">if</span> <span style="color: #0000aa">not</span> os.path.exists(directory):
        os.makedirs(directory)

    d = {}
    <span style="color: #0000aa">for</span> ticker <span style="color: #0000aa">in</span> tickers:
        filename = directory+<span style="color: #aa5500">&#39;/&#39;</span>+ticker+<span style="color: #aa5500">&#39;.csv&#39;</span>
        d[ticker] = web.DataReader(ticker,<span style="color: #aa5500">&quot;yahoo&quot;</span>,start,end)
        d[ticker].to_csv(filename)
</pre></div>
        <p>We now need to update our count variable for each stock we scrape data from. To do this we set count = count + 1. We then check if count % 50 == 0 and if it is we use the time module to sleep for 10 seconds. This will ensure that every 50 stocks scraped we wait so that yahoo finance does not block us. For instance, say we passed in a list of 500 tickers. Then, after the first 50 tickers we would sleep for 10 seconds, after 50 more stocks we would sleep for 10 seconds, and so on. This is the final piece of code for our function. Our completed function looks as follows:</p>
        <div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">pandas_datareader.data</span> <span style="color: #0000aa">as</span> <span style="color: #00aaaa; text-decoration: underline">web</span>
<span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">os</span>
<span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">datetime</span>
<span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">time</span>

<span style="color: #0000aa">def</span> <span style="color: #00aa00">download_data</span>(tickers,start,end,all_data=<span style="color: #00aaaa">False</span>):
    count = <span style="color: #009999">1</span>
    <span style="color: #0000aa">if</span> all_data==<span style="color: #00aaaa">True</span>:
        end = datetime.datetime.now()
        end = <span style="color: #aa5500">&#39;%s-%s-%s&#39;</span> % (end.month,end.day,end.year)
        start = <span style="color: #aa5500">&#39;01-01-1970&#39;</span>

    directory = <span style="color: #aa5500">&#39;stock_data&#39;</span>
    <span style="color: #0000aa">if</span> <span style="color: #0000aa">not</span> os.path.exists(directory):
        os.makedirs(directory)

    d = {}
    <span style="color: #0000aa">for</span> ticker <span style="color: #0000aa">in</span> tickers:
        filename = directory+<span style="color: #aa5500">&#39;/&#39;</span>+ticker+<span style="color: #aa5500">&#39;.csv&#39;</span>
        d[ticker] = web.DataReader(ticker,<span style="color: #aa5500">&quot;yahoo&quot;</span>,start,end)
        d[ticker].to_csv(filename)
        count  = count + <span style="color: #009999">1</span>
        <span style="color: #0000aa">if</span> count % <span style="color: #009999">50</span> == <span style="color: #009999">0</span>:
            time.sleep(<span style="color: #009999">10</span>)
    <span style="color: #0000aa">return</span>
</pre></div>

        <p>We now need to run our function. To do so we will create a list of tickers, start, and end date and pass these in to our download_data function. An example of doing so is as follows:</p>
        <div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">pandas_datareader.data</span> <span style="color: #0000aa">as</span> <span style="color: #00aaaa; text-decoration: underline">web</span>
<span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">os</span>
<span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">datetime</span>
<span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">time</span>

<span style="color: #0000aa">def</span> <span style="color: #00aa00">download_data</span>(tickers,start,end,all_data=<span style="color: #00aaaa">False</span>):
    count = <span style="color: #009999">1</span>
    <span style="color: #0000aa">if</span> all_data==<span style="color: #00aaaa">True</span>:
        end = datetime.datetime.now()
        end = <span style="color: #aa5500">&#39;%s-%s-%s&#39;</span> % (end.month,end.day,end.year)
        start = <span style="color: #aa5500">&#39;01-01-1970&#39;</span>

    directory = <span style="color: #aa5500">&#39;stock_data&#39;</span>
    <span style="color: #0000aa">if</span> <span style="color: #0000aa">not</span> os.path.exists(directory):
        os.makedirs(directory)

    d = {}
    <span style="color: #0000aa">for</span> ticker <span style="color: #0000aa">in</span> tickers:
        filename = directory+<span style="color: #aa5500">&#39;/&#39;</span>+ticker+<span style="color: #aa5500">&#39;.csv&#39;</span>
        d[ticker] = web.DataReader(ticker,<span style="color: #aa5500">&quot;yahoo&quot;</span>,start,end)
        d[ticker].to_csv(filename)
        count  = count + <span style="color: #009999">1</span>
        <span style="color: #0000aa">if</span> count % <span style="color: #009999">50</span> == <span style="color: #009999">0</span>:
            time.sleep(<span style="color: #009999">10</span>)
    <span style="color: #0000aa">return</span>

<span style="color: #0000aa">if</span> __name__ == <span style="color: #aa5500">&#39;__main__&#39;</span>:
    tickers = [<span style="color: #aa5500">&#39;AAPL&#39;</span>,<span style="color: #aa5500">&#39;BAC&#39;</span>,<span style="color: #aa5500">&#39;GILD&#39;</span>,<span style="color: #aa5500">&#39;MSFT&#39;</span>]
    start = <span style="color: #aa5500">&#39;2016-01-01&#39;</span>
    end = <span style="color: #aa5500">&#39;2016-12-21&#39;</span>
    download_data(tickers,start,end)
</pre></div>
        <p>We can run the above code and a directory called stock_data will contain AAPL.csv, BAC.csv, GILD.csv, and MSFT.csv for the specified start and end dates. If we wanted to download all data for the stocks we can add in the all_data=True parameter in our function call as follows:</p>
        <div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">pandas_datareader.data</span> <span style="color: #0000aa">as</span> <span style="color: #00aaaa; text-decoration: underline">web</span>
<span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">os</span>
<span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">datetime</span>
<span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">time</span>

<span style="color: #0000aa">def</span> <span style="color: #00aa00">download_data</span>(tickers,start,end,all_data=<span style="color: #00aaaa">False</span>):
    count = <span style="color: #009999">1</span>
    <span style="color: #0000aa">if</span> all_data==<span style="color: #00aaaa">True</span>:
        end = datetime.datetime.now()
        end = <span style="color: #aa5500">&#39;%s-%s-%s&#39;</span> % (end.month,end.day,end.year)
        start = <span style="color: #aa5500">&#39;01-01-1970&#39;</span>

    directory = <span style="color: #aa5500">&#39;stock_data&#39;</span>
    <span style="color: #0000aa">if</span> <span style="color: #0000aa">not</span> os.path.exists(directory):
        os.makedirs(directory)

    d = {}
    <span style="color: #0000aa">for</span> ticker <span style="color: #0000aa">in</span> tickers:
        filename = directory+<span style="color: #aa5500">&#39;/&#39;</span>+ticker+<span style="color: #aa5500">&#39;.csv&#39;</span>
        d[ticker] = web.DataReader(ticker,<span style="color: #aa5500">&quot;yahoo&quot;</span>,start,end)
        d[ticker].to_csv(filename)
        count  = count + <span style="color: #009999">1</span>
        <span style="color: #0000aa">if</span> count % <span style="color: #009999">50</span> == <span style="color: #009999">0</span>:
            time.sleep(<span style="color: #009999">10</span>)
    <span style="color: #0000aa">return</span>

<span style="color: #0000aa">if</span> __name__ == <span style="color: #aa5500">&#39;__main__&#39;</span>:
    tickers = [<span style="color: #aa5500">&#39;AAPL&#39;</span>,<span style="color: #aa5500">&#39;BAC&#39;</span>,<span style="color: #aa5500">&#39;GILD&#39;</span>,<span style="color: #aa5500">&#39;MSFT&#39;</span>]
    start = <span style="color: #aa5500">&#39;2016-01-01&#39;</span>
    end = <span style="color: #aa5500">&#39;2016-12-21&#39;</span>
    download_data(tickers,start,end,all_data=<span style="color: #00aaaa">True</span>)
</pre></div>
        <p>We now have downloaded all data for each stock ticker in our list of tickers.</p>

        <p>With the above function we have an automated way of pulling stock data. All we need to do is place the tickers as strings into the tickers list and provide a start date, end date, and optional all_data parameter and we have stock data within seconds!</p>
        <p>The above code (data_scraper.py) can be downloaded from <a href='https://github.com/ad1m/derivative_code'>here</a>.</p>


        







              
    </div>

  </main>
  </body>