<!DOCTYPE html>
<html >
<head>
  <meta charset="UTF-8">
  <title>Backtester</title>
  
  
  <link rel='stylesheet prefetch' href='https://fonts.googleapis.com/css?family=Inconsolata|Space+Mono:700'>
<link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css'>
<link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css'>

      <link rel="stylesheet" href="css/style.css">
      <script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>

      <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-89638118-1', 'auto');
  ga('send', 'pageview');

</script>
</head>

<body>
  <main>
  <style>
  a {
  	color: brown
  }
  .shorter {
    width: 450px;
  }
  </style>
  <div class="preview__link" href="#" itemprop="url">
              <span class="preview__date" itemprop="datePublished" datetime="2016-09-07T00:00:00-07:00">Jan 07, 2017</span>
              <center><h2 class="preview__header" itemprop="name">Building A Backtester</h2></center>
              <center><u><h4>What Will We Learn?</h4></u></center>
              <p>A trading strategy signals buy/sell orders for particular equities. To evaluate the strategy we need a backtester to simulate the trades, giving us a new updated portfolio value. We can the check the financial metrics of this portfolio value after all trades have been fulfiled to evaluate the efectiveness of the trading strategy.</p>
              <!--<p>Previously we constructed Quantitative financial metrics are important determinants of portfolio performance. There are a variety of financial metrics and we will code a bunch of them in this lesson. We will calculate total return, cumulative return, daily returns, average daily returns, volatilitility  </p> -->
              <center><u><h4>Libraries We Need</h4></u></center>
              <p>We need the following libraries for our program:
              <ol>
              <li>pandas: We will use the pandas dataframe to hold our adjusted close prices and a pandas series to hold our portfolio value. To install pandas go to your terminal or command prompt and use pip install pandas to download the pandas package on your machine. If you installed tha anaconda distribution then you have pandas installed.</li>
              <li>panda_datareader: We will use this to scrape our adjusted close prices into a dictionary, which we will then turn into a dataframe. To download this library go to your terminal or command prompt and type in pip install pandas-datareader. If you installed the anaconda distribution then you have this library on your machine.</li>
              <li>Matplotlib: This allows us to plot and is used in a previous portfolio construction file we will need to import. If you installed the anaconda distribution you have matplotlib. If not go to your terminal or command prompt and type in pip install matplotlib.</li>
              <li>Numpy: We will use numpy arrays and some mathematical functions from numpy. If you installed the anaconda distribution then you will have numpy. If not, go to your terminal or command prompt and pip install numpy to download this library.</li>
              <li>csv: We will use the csv module which comes with python. This will let us read in a csv order file.</li>
              </ol>
              <center><u><h4>Files We Need</h4></u></center>
              <p>In the second to last lesson, we wrote code to construct a portfolio in a python file called Portfolio_Constructor.py. We will import this code and its libraries into our new file. If you do not have the portfolio constructor code you can download Portfolio_Constructor.py from <a href='https://github.com/ad1m/derivative_code'>here</a>. Note, please place this file in the same directory as the new file that we are about to write. If you would like to learn more about how the Portfolio_Constructor code works you can check out the lesson <a href='portfolio_value.html'>here</a>. We also need the performance_metrics.py file from the last lesson. The performance_metrics.py file can be downloaded from <a href='https://github.com/ad1m/derivative_code'>here</a>. If you would like to learn more about this code check out the previous lesson <a href='financial_metrics.html'>here</a>. We also need to download the orders directory which contains a csv file called orders.csv. Keep the directory at the same level as the files above.</p>

              <center><u><h4>What Our Program Will Do</h4></u></center>
              <p>We will write code to create a backtester. We will feed a csv file that contains buy/sell orders into the backtester and it will execute the trades for us. It will return the portfolio value from the trades, which we can run the financial metrics on to evaluate the strength and risk of the portfolio.</p>

              <center><u><h4>Implementation</h4></u></center>
              <p>We start by creating a python file called simulator.py. We then import csv, the Portfolio_Constructor file, and the performance_metrics file. We do so as follows:</p>
              <div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">csv</span>
<span style="color: #0000aa">from</span> <span style="color: #00aaaa; text-decoration: underline">Portfolio_Constructor</span> <span style="color: #0000aa">import</span> *
<span style="color: #0000aa">from</span> <span style="color: #00aaaa; text-decoration: underline">performance_metrics</span> <span style="color: #0000aa">import</span> *
</pre></div>



              <p>Let us write a function called simulate which will take in a csv file of orders, a start date, an end date, and our initial starting capital. We will then open the csv file and turn it into a list of lists. We will remove the header using the pop function and then index through the list of lists and append the symbos into a new list. We do so as follows:</p>
              <div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #0000aa">def</span> <span style="color: #00aa00">simulate</span>(orders,start,end,starting_capital):
    symbols = []
    reader = csv.reader(<span style="color: #00aaaa">open</span>(orders,<span style="color: #aa5500">&#39;rU&#39;</span>),delimiter=<span style="color: #aa5500">&#39;,&#39;</span>,quoting=csv.QUOTE_NONE)
    ls_orders = [[x.strip() <span style="color: #0000aa">for</span> x <span style="color: #0000aa">in</span> row] <span style="color: #0000aa">for</span> row <span style="color: #0000aa">in</span> reader]
    ls_orders.pop(<span style="color: #009999">0</span>) <span style="color: #aaaaaa; font-style: italic">#removing header</span>
    <span style="color: #0000aa">for</span> i <span style="color: #0000aa">in</span> ls_orders:
        symbols.append(<span style="color: #00aaaa">str</span>(i[<span style="color: #009999">1</span>]))
</pre></div>

			  <p>We now create a range of dates and remove all duplicates from our list of tickers. We get the adjusted close prices for the list of tickers with our given start and end dates. We add a cash column to the dataframe and set it's value to 1. We then create a dataframe to hold the trades, which is a copy of our adjusted close price dataframe. However, we will make all entries 0. This dataframe will hold the number of shares we buy or sell and the amount of cash it costs for the transaction. If we buy we will have a positive number under the stock ticker in the dataframe and a negative number for the cost of this transaction in the cash column. If we sell we will have a negative number under the stock ticker and a positive number for the cost of the transaction in the cash column. We do so as follows:</p>
			  <div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">csv</span>
<span style="color: #0000aa">from</span> <span style="color: #00aaaa; text-decoration: underline">Portfolio_Constructor</span> <span style="color: #0000aa">import</span> *
<span style="color: #0000aa">from</span> <span style="color: #00aaaa; text-decoration: underline">performance_metrics</span> <span style="color: #0000aa">import</span> *

<span style="color: #0000aa">def</span> <span style="color: #00aa00">simulate</span>(orders,start,end,starting_capital):
    symbols = []
    reader = csv.reader(<span style="color: #00aaaa">open</span>(orders,<span style="color: #aa5500">&#39;rU&#39;</span>),delimiter=<span style="color: #aa5500">&#39;,&#39;</span>,quoting=csv.QUOTE_NONE)
    ls_orders = [[x.strip() <span style="color: #0000aa">for</span> x <span style="color: #0000aa">in</span> row] <span style="color: #0000aa">for</span> row <span style="color: #0000aa">in</span> reader]
    ls_orders.pop(<span style="color: #009999">0</span>) <span style="color: #aaaaaa; font-style: italic">#removing header</span>
    <span style="color: #0000aa">for</span> i <span style="color: #0000aa">in</span> ls_orders:
        symbols.append(<span style="color: #00aaaa">str</span>(i[<span style="color: #009999">1</span>]))
    dates = pd.date_range(start, end)
    tickers = <span style="color: #00aaaa">list</span>(<span style="color: #00aaaa">set</span>(symbols))
    df = get_adjusted_close(tickers,start,end)
    df[<span style="color: #aa5500">&#39;cash&#39;</span>] = <span style="color: #009999">1.0</span>
    df_trades = df.copy()
    df_trades[:] = <span style="color: #009999">0</span>
</pre></div>

			  <p>We now index through the list (ls_index) that holds all of our csv order data. We first turn the date in index 0 of i into a datetime object. We then check to make sure this date is between our start and end date to make sure it is a valid trade. If it is we pulll the symbol, trade (buy or sell), and the number of shares as an int into variables symbol, trade, and shares. If the trade is marked SELL then we make shares the negative of what it is currently. We then set df_trades[symbol][date] = df_trades[symbol][date]+shares, meaning we add the shares into the df_trades dataframe and we set df_trades['cash'][date] = df_trades['cash'][date] + -1*(df_trades[symbol][date])*df[symbol][date], meaning we add in the cash required for the transaction into the cash column in the df_trades dataframe. Our code so far looks as follows:</p>
			  <div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">csv</span>
<span style="color: #0000aa">from</span> <span style="color: #00aaaa; text-decoration: underline">Portfolio_Constructor</span> <span style="color: #0000aa">import</span> *
<span style="color: #0000aa">from</span> <span style="color: #00aaaa; text-decoration: underline">performance_metrics</span> <span style="color: #0000aa">import</span> *

<span style="color: #0000aa">def</span> <span style="color: #00aa00">simulate</span>(orders,start,end,starting_capital):
    symbols = []
    reader = csv.reader(<span style="color: #00aaaa">open</span>(orders,<span style="color: #aa5500">&#39;rU&#39;</span>),delimiter=<span style="color: #aa5500">&#39;,&#39;</span>,quoting=csv.QUOTE_NONE)
    ls_orders = [[x.strip() <span style="color: #0000aa">for</span> x <span style="color: #0000aa">in</span> row] <span style="color: #0000aa">for</span> row <span style="color: #0000aa">in</span> reader]
    ls_orders.pop(<span style="color: #009999">0</span>) <span style="color: #aaaaaa; font-style: italic">#removing header</span>
    <span style="color: #0000aa">for</span> i <span style="color: #0000aa">in</span> ls_orders:
        symbols.append(<span style="color: #00aaaa">str</span>(i[<span style="color: #009999">1</span>]))
    dates = pd.date_range(start, end)
    tickers = <span style="color: #00aaaa">list</span>(<span style="color: #00aaaa">set</span>(symbols))
    df = get_adjusted_close(tickers,start,end)
    df[<span style="color: #aa5500">&#39;cash&#39;</span>] = <span style="color: #009999">1.0</span>
    df_trades = df.copy()
    df_trades[:] = <span style="color: #009999">0</span>
    <span style="color: #0000aa">for</span> i <span style="color: #0000aa">in</span> ls_orders:
        date = pd.to_datetime(<span style="color: #00aaaa">str</span>(i[<span style="color: #009999">0</span>]))
        <span style="color: #0000aa">if</span> date <span style="color: #0000aa">in</span> dates:
            symbol = i[<span style="color: #009999">1</span>]
            trade = i[<span style="color: #009999">2</span>]
            shares = <span style="color: #00aaaa">int</span>(i[<span style="color: #009999">3</span>])
            <span style="color: #0000aa">if</span> trade == <span style="color: #aa5500">&#39;SELL&#39;</span>:
                shares = shares*-<span style="color: #009999">1</span>
            df_trades[symbol][date] = df_trades[symbol][date]+shares
            df_trades[<span style="color: #aa5500">&#39;cash&#39;</span>][date] = df_trades[<span style="color: #aa5500">&#39;cash&#39;</span>][date] + -<span style="color: #009999">1</span>*(df_trades[symbol][date])*df[symbol][date]
</pre></div>

			<p>We now want to create another dataframe called df_holdings to hold our final portfolio value. We get the adjusted close prices for the tickers and start and end date and then create a cash column and set it to 1.0. We then set all elements to 0 and make the cash column on the start date equal to the starting capital. We do all the above so that we have a dataframe that is the correct size with our initial starting capital. We then index through the orders and check again if our date is in the daterange between our initial start and end dates. If it is we set df_holdings[symbol][date] = df_holdings[symbol][date]+df_trades[symbol][date] and df_holdings['cash'][date] = df_holdings['cash'][date] + -1*(df_holdings[symbol][date]*df[symbol][date]). Here we again add in the trades and cash the cash required to make the trade. Our code looks as follows:</p>
			<div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">csv</span>
<span style="color: #0000aa">from</span> <span style="color: #00aaaa; text-decoration: underline">Portfolio_Constructor</span> <span style="color: #0000aa">import</span> *
<span style="color: #0000aa">from</span> <span style="color: #00aaaa; text-decoration: underline">performance_metrics</span> <span style="color: #0000aa">import</span> *

<span style="color: #0000aa">def</span> <span style="color: #00aa00">simulate</span>(orders,start,end,starting_capital):
    symbols = []
    reader = csv.reader(<span style="color: #00aaaa">open</span>(orders,<span style="color: #aa5500">&#39;rU&#39;</span>),delimiter=<span style="color: #aa5500">&#39;,&#39;</span>,quoting=csv.QUOTE_NONE)
    ls_orders = [[x.strip() <span style="color: #0000aa">for</span> x <span style="color: #0000aa">in</span> row] <span style="color: #0000aa">for</span> row <span style="color: #0000aa">in</span> reader]
    ls_orders.pop(<span style="color: #009999">0</span>) <span style="color: #aaaaaa; font-style: italic">#removing header</span>
    <span style="color: #0000aa">for</span> i <span style="color: #0000aa">in</span> ls_orders:
        symbols.append(<span style="color: #00aaaa">str</span>(i[<span style="color: #009999">1</span>]))
    dates = pd.date_range(start, end)
    tickers = <span style="color: #00aaaa">list</span>(<span style="color: #00aaaa">set</span>(symbols))
    df = get_adjusted_close(tickers,start,end)
    df[<span style="color: #aa5500">&#39;cash&#39;</span>] = <span style="color: #009999">1.0</span>
    df_trades = df.copy()
    df_trades[:] = <span style="color: #009999">0</span>
    <span style="color: #0000aa">for</span> i <span style="color: #0000aa">in</span> ls_orders:
        date = pd.to_datetime(<span style="color: #00aaaa">str</span>(i[<span style="color: #009999">0</span>]))
        <span style="color: #0000aa">if</span> date <span style="color: #0000aa">in</span> dates:
            symbol = i[<span style="color: #009999">1</span>]
            trade = i[<span style="color: #009999">2</span>]
            shares = <span style="color: #00aaaa">int</span>(i[<span style="color: #009999">3</span>])
            <span style="color: #0000aa">if</span> trade == <span style="color: #aa5500">&#39;SELL&#39;</span>:
                shares = shares*-<span style="color: #009999">1</span>
            df_trades[symbol][date] = df_trades[symbol][date]+shares
            df_trades[<span style="color: #aa5500">&#39;cash&#39;</span>][date] = df_trades[<span style="color: #aa5500">&#39;cash&#39;</span>][date] + -<span style="color: #009999">1</span>*(df_trades[symbol][date])*df[symbol][date]
        df_holdings = get_adjusted_close(tickers,start,end)
        df_holdings[<span style="color: #aa5500">&#39;cash&#39;</span>] = <span style="color: #009999">1.0</span>
        df_holdings[:] = <span style="color: #009999">0</span>
        df_holdings[<span style="color: #aa5500">&#39;cash&#39;</span>][start] = starting_capital
        <span style="color: #0000aa">for</span> i <span style="color: #0000aa">in</span> ls_orders:
            date = <span style="color: #00aaaa">str</span>(i[<span style="color: #009999">0</span>])
            date = pd.to_datetime(date)
            <span style="color: #0000aa">if</span> date <span style="color: #0000aa">in</span> dates:
                symbol = i[<span style="color: #009999">1</span>]
                df_holdings[symbol][date] = df_holdings[symbol][date]+df_trades[symbol][date]
                df_holdings[<span style="color: #aa5500">&#39;cash&#39;</span>][date] = df_holdings[<span style="color: #aa5500">&#39;cash&#39;</span>][date] + -<span style="color: #009999">1</span>*(df_holdings[symbol][date]*df[symbol][date])
</pre></div>

			<p>We now perform a cumulative sum on the holdings dataframe and multiply it by the original adjusted close dataframe. Finally, we sum the columns and return our portfolio value. Our completed code is as follows:</p>
			<div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">csv</span>
<span style="color: #0000aa">from</span> <span style="color: #00aaaa; text-decoration: underline">Portfolio_Constructor</span> <span style="color: #0000aa">import</span> *
<span style="color: #0000aa">from</span> <span style="color: #00aaaa; text-decoration: underline">performance_metrics</span> <span style="color: #0000aa">import</span> *

<span style="color: #0000aa">def</span> <span style="color: #00aa00">simulate</span>(orders,start,end,starting_capital):
    symbols = []
    reader = csv.reader(<span style="color: #00aaaa">open</span>(orders,<span style="color: #aa5500">&#39;rU&#39;</span>),delimiter=<span style="color: #aa5500">&#39;,&#39;</span>,quoting=csv.QUOTE_NONE)
    ls_orders = [[x.strip() <span style="color: #0000aa">for</span> x <span style="color: #0000aa">in</span> row] <span style="color: #0000aa">for</span> row <span style="color: #0000aa">in</span> reader]
    ls_orders.pop(<span style="color: #009999">0</span>) <span style="color: #aaaaaa; font-style: italic">#removing header</span>
    <span style="color: #0000aa">for</span> i <span style="color: #0000aa">in</span> ls_orders:
        symbols.append(<span style="color: #00aaaa">str</span>(i[<span style="color: #009999">1</span>]))
    dates = pd.date_range(start, end)
    tickers = <span style="color: #00aaaa">list</span>(<span style="color: #00aaaa">set</span>(symbols))
    df = get_adjusted_close(tickers,start,end)
    df[<span style="color: #aa5500">&#39;cash&#39;</span>] = <span style="color: #009999">1.0</span>
    df_trades = df.copy()
    df_trades[:] = <span style="color: #009999">0</span>
    <span style="color: #0000aa">for</span> i <span style="color: #0000aa">in</span> ls_orders:
        date = pd.to_datetime(<span style="color: #00aaaa">str</span>(i[<span style="color: #009999">0</span>]))
        <span style="color: #0000aa">if</span> date <span style="color: #0000aa">in</span> dates:
            symbol = i[<span style="color: #009999">1</span>]
            trade = i[<span style="color: #009999">2</span>]
            shares = <span style="color: #00aaaa">int</span>(i[<span style="color: #009999">3</span>])
            <span style="color: #0000aa">if</span> trade == <span style="color: #aa5500">&#39;SELL&#39;</span>:
                shares = shares*-<span style="color: #009999">1</span>
            df_trades[symbol][date] = df_trades[symbol][date]+shares
            df_trades[<span style="color: #aa5500">&#39;cash&#39;</span>][date] = df_trades[<span style="color: #aa5500">&#39;cash&#39;</span>][date] + -<span style="color: #009999">1</span>*(df_trades[symbol][date])*df[symbol][date]
        df_holdings = get_adjusted_close(tickers,start,end)
        df_holdings[<span style="color: #aa5500">&#39;cash&#39;</span>] = <span style="color: #009999">1.0</span>
        df_holdings[:] = <span style="color: #009999">0</span>
        df_holdings[<span style="color: #aa5500">&#39;cash&#39;</span>][start] = starting_capital
        <span style="color: #0000aa">for</span> i <span style="color: #0000aa">in</span> ls_orders:
            date = <span style="color: #00aaaa">str</span>(i[<span style="color: #009999">0</span>])
            date = pd.to_datetime(date)
            <span style="color: #0000aa">if</span> date <span style="color: #0000aa">in</span> dates:
                symbol = i[<span style="color: #009999">1</span>]
                df_holdings[symbol][date] = df_holdings[symbol][date]+df_trades[symbol][date]
                df_holdings[<span style="color: #aa5500">&#39;cash&#39;</span>][date] = df_holdings[<span style="color: #aa5500">&#39;cash&#39;</span>][date] + -<span style="color: #009999">1</span>*(df_holdings[symbol][date]*df[symbol][date])
        df_holdings = df_holdings.cumsum()
        df_value = df_holdings*df
        portvals = df_value.sum(axis=<span style="color: #009999">1</span>)
    <span style="color: #0000aa">return</span> portvals
</pre></div>
			  <p>Let us now run our orders.csv file through the backtester and look at the output. We will start with $100,000 and let our trades run from 2011-01-05 to 2011-12-20. Our main method looks as follows:</p>
			  <div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #0000aa">import</span> <span style="color: #00aaaa; text-decoration: underline">csv</span>
<span style="color: #0000aa">from</span> <span style="color: #00aaaa; text-decoration: underline">Portfolio_Constructor</span> <span style="color: #0000aa">import</span> *
<span style="color: #0000aa">from</span> <span style="color: #00aaaa; text-decoration: underline">performance_metrics</span> <span style="color: #0000aa">import</span> *

<span style="color: #0000aa">def</span> <span style="color: #00aa00">simulate</span>(orders,start,end,starting_capital):
    symbols = []
    reader = csv.reader(<span style="color: #00aaaa">open</span>(orders,<span style="color: #aa5500">&#39;rU&#39;</span>),delimiter=<span style="color: #aa5500">&#39;,&#39;</span>,quoting=csv.QUOTE_NONE)
    ls_orders = [[x.strip() <span style="color: #0000aa">for</span> x <span style="color: #0000aa">in</span> row] <span style="color: #0000aa">for</span> row <span style="color: #0000aa">in</span> reader]
    ls_orders.pop(<span style="color: #009999">0</span>) <span style="color: #aaaaaa; font-style: italic">#removing header</span>
    <span style="color: #0000aa">for</span> i <span style="color: #0000aa">in</span> ls_orders:
        symbols.append(<span style="color: #00aaaa">str</span>(i[<span style="color: #009999">1</span>]))
    dates = pd.date_range(start, end)
    tickers = <span style="color: #00aaaa">list</span>(<span style="color: #00aaaa">set</span>(symbols))
    df = get_adjusted_close(tickers,start,end)
    df[<span style="color: #aa5500">&#39;cash&#39;</span>] = <span style="color: #009999">1.0</span>
    df_trades = df.copy()
    df_trades[:] = <span style="color: #009999">0</span>
    <span style="color: #0000aa">for</span> i <span style="color: #0000aa">in</span> ls_orders:
        date = pd.to_datetime(<span style="color: #00aaaa">str</span>(i[<span style="color: #009999">0</span>]))
        <span style="color: #0000aa">if</span> date <span style="color: #0000aa">in</span> dates:
            symbol = i[<span style="color: #009999">1</span>]
            trade = i[<span style="color: #009999">2</span>]
            shares = <span style="color: #00aaaa">int</span>(i[<span style="color: #009999">3</span>])
            <span style="color: #0000aa">if</span> trade == <span style="color: #aa5500">&#39;SELL&#39;</span>:
                shares = shares*-<span style="color: #009999">1</span>
            df_trades[symbol][date] = df_trades[symbol][date]+shares
            df_trades[<span style="color: #aa5500">&#39;cash&#39;</span>][date] = df_trades[<span style="color: #aa5500">&#39;cash&#39;</span>][date] + -<span style="color: #009999">1</span>*(df_trades[symbol][date])*df[symbol][date]
        df_holdings = get_adjusted_close(tickers,start,end)
        df_holdings[<span style="color: #aa5500">&#39;cash&#39;</span>] = <span style="color: #009999">1.0</span>
        df_holdings[:] = <span style="color: #009999">0</span>
        df_holdings[<span style="color: #aa5500">&#39;cash&#39;</span>][start] = starting_capital
        <span style="color: #0000aa">for</span> i <span style="color: #0000aa">in</span> ls_orders:
            date = <span style="color: #00aaaa">str</span>(i[<span style="color: #009999">0</span>])
            date = pd.to_datetime(date)
            <span style="color: #0000aa">if</span> date <span style="color: #0000aa">in</span> dates:
                symbol = i[<span style="color: #009999">1</span>]
                df_holdings[symbol][date] = df_holdings[symbol][date]+df_trades[symbol][date]
                df_holdings[<span style="color: #aa5500">&#39;cash&#39;</span>][date] = df_holdings[<span style="color: #aa5500">&#39;cash&#39;</span>][date] + -<span style="color: #009999">1</span>*(df_holdings[symbol][date]*df[symbol][date])
        df_holdings = df_holdings.cumsum()
        df_value = df_holdings*df
        portvals = df_value.sum(axis=<span style="color: #009999">1</span>)
    <span style="color: #0000aa">return</span> portvals

<span style="color: #0000aa">if</span> __name__ == <span style="color: #aa5500">&#39;__main__&#39;</span>:
    f = <span style="color: #aa5500">&#39;Orders/orders.csv&#39;</span>
    start = <span style="color: #aa5500">&#39;2011-01-05&#39;</span>
    end = <span style="color: #aa5500">&#39;2011-12-20&#39;</span>
    starting_capital = <span style="color: #009999">100000</span>
    pv = simulate(f,start,end,starting_capital)
    <span style="color: #0000aa">print</span> pv
    cr = cumulative_returns(pv)
    dr = daily_returns(pv)
    adr = average_daily_returns(pv)
    vol = volatility(pv)
    sr = Sharpe_Ratio(pv)
    <span style="color: #0000aa">print</span> <span style="color: #aa5500">&#39;------- Performance -------\n&#39;</span>
    <span style="color: #0000aa">print</span> <span style="color: #aa5500">&#39;Cumulative Return: &#39;</span> + <span style="color: #00aaaa">str</span>(cr) +<span style="color: #aa5500">&#39;\n&#39;</span>
    <span style="color: #0000aa">print</span> <span style="color: #aa5500">&#39;Daily Returns: \n&#39;</span>
    <span style="color: #0000aa">print</span> dr
    <span style="color: #0000aa">print</span> <span style="color: #aa5500">&#39;\n&#39;</span>
    <span style="color: #0000aa">print</span> <span style="color: #aa5500">&#39;Average Daily Return:&#39;</span> + <span style="color: #00aaaa">str</span>(adr) + <span style="color: #aa5500">&#39;\n&#39;</span>
    <span style="color: #0000aa">print</span> <span style="color: #aa5500">&#39;Volatility: &#39;</span> + <span style="color: #00aaaa">str</span>(vol) + <span style="color: #aa5500">&#39;\n&#39;</span>
    <span style="color: #0000aa">print</span> <span style="color: #aa5500">&#39;Sharpe Ratio: &#39;</span> + <span style="color: #00aaaa">str</span>(sr) + <span style="color: #aa5500">&#39;\n&#39;</span>
</pre></div>

			  <p>Our output is as follows:</p>
			  <div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">Date
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">05</span>    <span style="color: #009999">100000.000000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">06</span>    <span style="color: #009999">100000.000000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">07</span>    <span style="color: #009999">100000.000000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">10</span>    <span style="color: #009999">100000.000000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">11</span>    <span style="color: #009999">100000.000000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">12</span>    <span style="color: #009999">100000.000000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">13</span>    <span style="color: #009999">100000.000000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">14</span>    <span style="color: #009999">100000.000000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">18</span>     <span style="color: #009999">98471.731000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">19</span>     <span style="color: #009999">98118.451000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">20</span>     <span style="color: #009999">98498.603000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">21</span>     <span style="color: #009999">97461.819000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">24</span>    <span style="color: #009999">111734.791000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">25</span>    <span style="color: #009999">117990.003000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">26</span>    <span style="color: #009999">116607.603000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">27</span>    <span style="color: #009999">116711.331000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">28</span>    <span style="color: #009999">110283.311000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">31</span>    <span style="color: #009999">119925.311000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">01</span>    <span style="color: #009999">125537.026000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">02</span>    <span style="color: #009999">124596.102000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">03</span>    <span style="color: #009999">125145.026000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">04</span>    <span style="color: #009999">126871.076000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">07</span>    <span style="color: #009999">127880.037000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">08</span>    <span style="color: #009999">136197.725000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">09</span>    <span style="color: #009999">132533.477000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">10</span>    <span style="color: #009999">127990.861000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">11</span>    <span style="color: #009999">128232.979000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">14</span>    <span style="color: #009999">126030.150000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">15</span>    <span style="color: #009999">124617.850000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">16</span>    <span style="color: #009999">126612.001000</span>
                  ...      
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">08</span>    <span style="color: #009999">134675.733255</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">09</span>    <span style="color: #009999">132965.940855</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">10</span>    <span style="color: #009999">131395.118055</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">11</span>    <span style="color: #009999">131301.429255</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">14</span>    <span style="color: #009999">130464.490455</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">15</span>    <span style="color: #009999">131958.802455</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">16</span>    <span style="color: #009999">131324.853255</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">17</span>    <span style="color: #009999">130175.621655</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">18</span>    <span style="color: #009999">129789.942855</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">21</span>    <span style="color: #009999">128863.997655</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">22</span>    <span style="color: #009999">130035.090855</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">23</span>    <span style="color: #009999">128548.584855</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">25</span>    <span style="color: #009999">128014.568055</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">28</span>    <span style="color: #009999">129974.195655</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">29</span>    <span style="color: #009999">129518.248455</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">30</span>    <span style="color: #009999">130923.556455</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">01</span>    <span style="color: #009999">131818.271655</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">02</span>    <span style="color: #009999">132094.649655</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">05</span>    <span style="color: #009999">132611.493255</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">06</span>    <span style="color: #009999">132289.829655</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">07</span>    <span style="color: #009999">131999.400855</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">08</span>    <span style="color: #009999">132244.548855</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">09</span>    <span style="color: #009999">132706.742055</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">12</span>    <span style="color: #009999">132428.800455</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">13</span>    <span style="color: #009999">131955.678855</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">14</span>    <span style="color: #009999">130609.707255</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">15</span>    <span style="color: #009999">130609.707255</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">16</span>    <span style="color: #009999">130609.707255</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">19</span>    <span style="color: #009999">130609.707255</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">20</span>    <span style="color: #009999">130609.707255</span>
dtype: float64
------- Performance -------

Cumulative Return: <span style="color: #009999">0.30609707255</span>

Daily Returns: 

Date
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">06</span>    <span style="color: #009999">0.000000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">07</span>    <span style="color: #009999">0.000000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">10</span>    <span style="color: #009999">0.000000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">11</span>    <span style="color: #009999">0.000000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">12</span>    <span style="color: #009999">0.000000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">13</span>    <span style="color: #009999">0.000000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">14</span>    <span style="color: #009999">0.000000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">18</span>   -<span style="color: #009999">0.015283</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">19</span>   -<span style="color: #009999">0.003588</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">20</span>    <span style="color: #009999">0.003874</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">21</span>   -<span style="color: #009999">0.010526</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">24</span>    <span style="color: #009999">0.146447</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">25</span>    <span style="color: #009999">0.055983</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">26</span>   -<span style="color: #009999">0.011716</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">27</span>    <span style="color: #009999">0.000890</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">28</span>   -<span style="color: #009999">0.055076</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">01</span>-<span style="color: #009999">31</span>    <span style="color: #009999">0.087429</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">01</span>    <span style="color: #009999">0.046793</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">02</span>   -<span style="color: #009999">0.007495</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">03</span>    <span style="color: #009999">0.004406</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">04</span>    <span style="color: #009999">0.013792</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">07</span>    <span style="color: #009999">0.007953</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">08</span>    <span style="color: #009999">0.065043</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">09</span>   -<span style="color: #009999">0.026904</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">10</span>   -<span style="color: #009999">0.034275</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">11</span>    <span style="color: #009999">0.001892</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">14</span>   -<span style="color: #009999">0.017178</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">15</span>   -<span style="color: #009999">0.011206</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">16</span>    <span style="color: #009999">0.016002</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">02</span>-<span style="color: #009999">17</span>    <span style="color: #009999">0.024299</span>
                ...   
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">08</span>    <span style="color: #009999">0.007593</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">09</span>   -<span style="color: #009999">0.012696</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">10</span>   -<span style="color: #009999">0.011814</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">11</span>   -<span style="color: #009999">0.000713</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">14</span>   -<span style="color: #009999">0.006374</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">15</span>    <span style="color: #009999">0.011454</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">16</span>   -<span style="color: #009999">0.004804</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">17</span>   -<span style="color: #009999">0.008751</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">18</span>   -<span style="color: #009999">0.002963</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">21</span>   -<span style="color: #009999">0.007134</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">22</span>    <span style="color: #009999">0.009088</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">23</span>   -<span style="color: #009999">0.011432</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">25</span>   -<span style="color: #009999">0.004154</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">28</span>    <span style="color: #009999">0.015308</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">29</span>   -<span style="color: #009999">0.003508</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">11</span>-<span style="color: #009999">30</span>    <span style="color: #009999">0.010850</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">01</span>    <span style="color: #009999">0.006834</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">02</span>    <span style="color: #009999">0.002097</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">05</span>    <span style="color: #009999">0.003913</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">06</span>   -<span style="color: #009999">0.002426</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">07</span>   -<span style="color: #009999">0.002195</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">08</span>    <span style="color: #009999">0.001857</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">09</span>    <span style="color: #009999">0.003495</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">12</span>   -<span style="color: #009999">0.002094</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">13</span>   -<span style="color: #009999">0.003573</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">14</span>   -<span style="color: #009999">0.010200</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">15</span>    <span style="color: #009999">0.000000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">16</span>    <span style="color: #009999">0.000000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">19</span>    <span style="color: #009999">0.000000</span>
<span style="color: #009999">2011</span>-<span style="color: #009999">12</span>-<span style="color: #009999">20</span>    <span style="color: #009999">0.000000</span>
dtype: float64


Average Daily Return:<span style="color: #009999">0.00131516088172</span>

Volatility: <span style="color: #009999">0.0207416663918</span>

Sharpe Ratio: <span style="color: #009999">1.00655035946</span>
</pre></div>

			  <p>We see that we have made a good amount of money as shown by our cumulative return, have a positive average daily return, a decently high volatility, and a good sharpe ratio above 1.0. Our sample orders form gave us great results.</p>
			  <p>We now have a backtester to run our trades through. Next, we will code some technical indicators and then write a strategy based off of them. We will then feed them through our backtester and examine the strategy performance.</p>


              
	<p>The above code (simulator.py) can be downloaded from <a href='https://github.com/ad1m/derivative_code'>here</a>.</p>

        <!--<p>With the above function we have an automated way of pulling stock data. All we need to do is place the tickers as strings into the tickers list and provide a start date, end date, and optional all_data parameter and we have stock data within seconds!</p>
        <p>The above code (data_scraper.py) can be downloaded from <a href='https://github.com/ad1m/derivative_code'>here</a>.</p> -->


        







              
    </div>

  </main>
  </body>